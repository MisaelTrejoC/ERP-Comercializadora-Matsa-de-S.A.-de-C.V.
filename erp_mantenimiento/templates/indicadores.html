<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/logo empresa.png" type="image/png">
    <title>Matsa - Indicador general</title>
    <style>
        .form-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fcfcfc;
        }

        .form-section .input-group {
            display: flex;
            flex-direction: column;
        }

        .form-section .input-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-section .input-group input[type="text"],
        .form-section .input-group select,
        .form-section .input-group input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <nav>
        <header>
            <img src="/static/logo empresa.png" alt="Logo Empresa"/>
        </header>
        <h2>MATSA - Base de datos</h2>
        <ul>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/">Almacenamiento</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/mantenimento">Mantenimiento</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/piezas">Produccion</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/indicadores">Indicadores</a>
                </div>
                <div id="mantenimento-menu" class="dropdown-menu">
                    <a href="/indicador_mantenimiento">Indicador mantenimento</a>
                    <a href="/indicador_calidad">Indicador calidad</a>
                    <a href="/indicador_produccion">Indicador produccion</a>
                </div>
            </li>
        </ul>
    </nav>

    <main>
        <h2>Panel general - Indicadores</h2>
        
        <section class="form-section">
            <div>
                <label for="indicador-select">Seleccione un indicador:</label>
                <select id="indicador-select">
                    <option value="mantenimiento">Indicador Mantenimiento</option>
                    <option value="calidad">Indicador Calidad</option>
                </select>
            </div>
        </section>
        <h2>Vista previa graficas</h2>
    <section class="form-section">
            <div class="main-content">
    <div id="mantenimiento-container" style="display: none;">
        <h2>Gráfica de Cumplimiento de Mantenimiento</h2>
        <div class="chart-container">
            <canvas id="maintenanceChart"></canvas>
        </div>
    </div>

    <div id="calidad-container" style="display: none;">
        <h2>Gráfica de Índice de Scrap (Calidad)</h2>
        <div class="chart-container">
            <canvas id="qualityChart"></canvas>
        </div>
    </div>
</div>

        </section>

        <table id="totalsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Mes</th>
                </tr>
            </thead>
            <tbody>
                <tr id="total-realized-row">
                    <td>Total Realizados</td>
                </tr>
                <tr id="total-scheduled-row">
                    <td>Programadas</td>
                </tr>
            </tbody>
        </table>

        <div class="button-group">
            <button id="viewIndicatorBtn" class="btn btn-primary">Ver indicador</button>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
<script>
    const weeksPerMonth = {
        'Enero': 4, 'Febrero': 4, 'Marzo': 5, 'Abril': 4, 'Mayo': 5, 'Junio': 4,
        'Julio': 4, 'Agosto': 5, 'Septiembre': 4, 'Octubre': 4, 'Noviembre': 5, 'Diciembre': 4
    };
    const monthNames = Object.keys(weeksPerMonth);
    
    const domElements = {
        totalsTable: document.getElementById('totalsTable'),
        maintenanceChart: document.getElementById('maintenanceChart'),
        viewIndicatorBtn: document.getElementById('viewIndicatorBtn'),
        maintenanceContainer: document.getElementById('mantenimiento-container'),
        qualityContainer: document.getElementById('calidad-container')
    };
    
    let myChart = null;

    async function getMaintenanceRecords() {
        try {
            const response = await fetch('/api/mantenimiento');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching maintenance records:', error);
            return [];
        }
    }
    
    // Nueva función para obtener los datos de Calidad desde el backend
    async function getQualityChartData() {
        const scrapPercentages = [];
        const labels = [];
        
        for (let i = 1; i <= monthNames.length; i++) {
            try {
                const response = await fetch(`/api/get_all_monthly_data?month=${i}`);
                if (!response.ok) {
                    throw new Error(`Error fetching data for month ${i}`);
                }
                const result = await response.json();
                
                if (result.success && result.data) {
                    const totalManufactured = result.data.total_manufactured;
                    const totalScrap = result.data.total_scrap;
                    let scrapPercentage = 0;
                    if (totalManufactured > 0) {
                        scrapPercentage = ((totalScrap / totalManufactured) * 100).toFixed(2);
                    }
                    scrapPercentages.push(parseFloat(scrapPercentage));
                    labels.push(monthNames[i-1]);
                }
            } catch (error) {
                console.error(`Error en la solicitud para el mes ${monthNames[i-1]}:`, error);
                scrapPercentages.push(0); // Agrega 0 si hay un error para mantener la consistencia
                labels.push(monthNames[i-1]);
            }
        }
        return { scrapPercentages, labels };
    }

    function showChartContainer(chartId) {
        const containers = {
            'mantenimiento-container': domElements.maintenanceContainer,
            'calidad-container': domElements.qualityContainer
        };

        for (const id in containers) {
            if (containers[id]) {
                containers[id].style.display = 'none';
            }
        }

        if (containers[chartId]) {
            containers[chartId].style.display = 'block';
        }
    }
    
    function createMaintenanceChart(realizedData, scheduledData, labels) {
        if (myChart) {
            myChart.destroy();
        }

        const ctx = domElements.maintenanceChart.getContext('2d');
        
        const realizedPercentages = labels.map((month, index) => {
            const scheduled = scheduledData[index];
            const realized = realizedData[index];
            return scheduled > 0 ? ((realized / scheduled) * 100).toFixed(2) : 0;
        });

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '% Cumplimiento',
                    data: realizedPercentages,
                    backgroundColor: realizedPercentages.map(percentage => {
                        return percentage >= 80 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)';
                    }),
                    borderColor: realizedPercentages.map(percentage => {
                        return percentage >= 80 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                animation: {
                x: {
                    duration: 0,
                    from: 0,
                    to: 'x', // Desactiva la animación del eje X
                },
                y: {
                    duration: 1000, // Duración de la animación en milisegundos (1 segundo)
                     // Empieza desde el 0 del eje Y
                }
            },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Porcentaje (%)'
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                return `Cumplimiento: ${value}%`;
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 80,
                                yMax: 80,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                label: {
                                    content: 'Meta Mínima: 80%',
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    async function getChartData() {
        const maintenanceRecords = await getMaintenanceRecords();
        
        const realizedTotals = {};
        monthNames.forEach(month => {
            realizedTotals[month] = 0;
        });

        maintenanceRecords.forEach(record => {
            monthNames.forEach(month => {
                const weeksInMonth = weeksPerMonth[month];
                for (let i = 1; i <= weeksInMonth; i++) {
                    const statusKey = `${month}-${i}`;
                    if (record.status[statusKey] && record.status[statusKey].status === 'done') {
                        realizedTotals[month]++;
                    }
                }
            });
        });

        const realizedData = monthNames.map(month => realizedTotals[month]);
        
        const scheduledData = monthNames.map(month => {
            const savedValue = localStorage.getItem(`scheduled-${month}`);
            return savedValue ? parseInt(savedValue, 10) || 0 : 0;
        });
        
        return { realizedData, scheduledData, labels: monthNames };
    }

    function createQualityChart(scrapPercentages, labels) {
        if (myChart) {
            myChart.destroy();
        }

        const ctx = document.getElementById('qualityChart').getContext('2d');
        
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Índice de Scrap (%)',
                    data: scrapPercentages,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                animation: {
                x: {
                    duration: 0,
                    from: 0,
                    to: 'x', // Desactiva la animación del eje X
                },
                y: {
                    duration: 1000, // Duración de la animación en milisegundos (1 segundo)
                     // Empieza desde el 0 del eje Y
                }
            },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5,
                        title: {
                            display: true,
                            text: 'Porcentaje de Scrap'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Indicador de Calidad por Mes'
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 2.5,
                                yMax: 2.5,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                label: {
                                    content: 'Objetivo: 2.5%',
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    domElements.viewIndicatorBtn.addEventListener('click', async () => {
        const selectedIndicator = document.getElementById('indicador-select').value;
        
        if (selectedIndicator === 'mantenimiento') {
            const { realizedData, scheduledData, labels } = await getChartData();
            createMaintenanceChart(realizedData, scheduledData, labels);
            showChartContainer('mantenimiento-container');
        } else if (selectedIndicator === 'calidad') {
            const { scrapPercentages, labels } = await getQualityChartData();
            createQualityChart(scrapPercentages, labels);
            showChartContainer('calidad-container');
        }
    });
</script>
</body>
</html>