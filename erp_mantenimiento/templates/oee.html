<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="/static/style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/logo empresa.png" type="image/png">
    <title>Matsa - Indicador de cumplimiento OEE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <style>
        .chart-container {
            width: 90%;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div class="profile-menu-container-top-right">
        <div class="profile-toggle">
            <div class="profile-toggle-content">
                
                <svg class="user-svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12ZM12 14C7.02944 14 3 18.0294 3 23H21C21 18.0294 16.9706 14 12 14Z" fill="white"/>
                </svg>
                
                <span id="user-display">{{ session.get('username', 'Invitado') }}</span>
                <span class="arrow-icon">▲</span>
            </div>
        </div>
        <div class="profile-dropdown-menu hidden">
            <p><strong>Usuario:</strong> {{ session.get('username', 'Invitado') }}</p>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Cerrar sesión</a>
        </div>
    </div>
    <nav>
        <header>
            <img src="/static/logo empresa.png" alt="Logo Empresa"/>
        </header>
        <h2>MATSA - Base de datos</h2>
        <ul>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/">Almacen</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/mantenimento">Mantenimiento</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/piezas">Produccion</a>
                </div>
                <div id="piezas-menu" class="dropdown-menu">
                    <a href="/lista_numeros_de_parte_y_piezas_por_barra">Numeros de parte</a>
                    <a href="/eficiencia">Eficiencia de tornos</a>
                    <a href="/disponibilidad">Disponibilidad</a>
                    <a href="/oee">OEE</a>
                    <a href="/tiempo_muerto_scrap">Tiempo muerto</a>
                </div>
            </li>
            {% if user_role == 'admin' %}
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/indicadores">Indicadores</a>
                </div>
            </li>
            {% endif %}
        </ul>
    </nav>
    <main>
        <h2>OEE - produccion</h2>
        <section class="data-table-section">
            <table id="oeeTable">
                <thead>
                    <tr>
                        <th>Máquina</th>
                        <th>Disponibilidad (%)</th>
                        <th>Rendimiento (%)</th>
                        <th>Calidad (%)</th>
                        <th>OEE (%)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </section>
                    <h3>Gráfico de OEE por Máquina</h3>
        <section class="form-section">
        <section class="chart-container">
            <canvas id="oeeChart"></canvas>
        </section>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            const profileToggle = document.querySelector('.profile-toggle');
            const profileContainer = document.querySelector('.profile-menu-container-top-right');
            const profileMenu = document.querySelector('.profile-dropdown-menu');

            if (profileToggle && profileMenu && profileContainer) {
                profileToggle.addEventListener('click', () => {
                    // Oculta/Muestra el menú usando la clase 'hidden'
                    profileMenu.classList.toggle('hidden'); 
                    // Añade/Remueve la clase 'active' para girar el icono de la flecha
                    profileContainer.classList.toggle('active');
                });
            }
            document.addEventListener('click', (event) => {
                const profileContainer = document.querySelector('.profile-menu-container-top-right');
                const isClickInsideContainer = event.target.closest('.profile-menu-container-top-right');
                
                if (!profileMenu.classList.contains('hidden') && !isClickInsideContainer) {
                    profileMenu.classList.add('hidden');
                    if (profileContainer) {
                        profileContainer.classList.remove('active'); // Asegura que la flecha vuelva a subir
                    }
                }
            });
            async function obtenerYCalcularOEE() {
                try {
                    const [eficienciaResponse, disponibilidadResponse] = await Promise.all([
                        fetch('/obtener_eficiencias'),
                        fetch('/obtener_disponibilidades')
                    ]);

                    if (!eficienciaResponse.ok || !disponibilidadResponse.ok) {
                        throw new Error('Error al obtener los datos del servidor');
                    }

                    const eficienciaData = await eficienciaResponse.json();
                    const disponibilidadData = await disponibilidadResponse.json();

                    // Mapear los datos de disponibilidad por máquina
                    const disponibilidadPorMaquina = {};
                    disponibilidadData.forEach(item => {
                        if (!disponibilidadPorMaquina[item.maquina]) {
                            disponibilidadPorMaquina[item.maquina] = [];
                        }
                        disponibilidadPorMaquina[item.maquina].push(item);
                    });

                    // Mapear los datos de eficiencia por máquina
                    const eficienciaPorMaquina = {};
                    eficienciaData.forEach(item => {
                        if (!eficienciaPorMaquina[item.maquina]) {
                            eficienciaPorMaquina[item.maquina] = [];
                        }
                        eficienciaPorMaquina[item.maquina].push(item);
                    });

                    // Obtener todas las máquinas únicas de ambos datasets
                    const maquinasUnicas = [...new Set([
                        ...Object.keys(eficienciaPorMaquina),
                        ...Object.keys(disponibilidadPorMaquina)
                    ])];

                    const oeePorMaquina = {};
                    maquinasUnicas.forEach(maquina => {
                        let totalMinutosParo = 0;
                        let totalHorasTeoricas = 0;
                        let totalPiezasProgramadas = 0;
                        let totalPiezasReales = 0;
                        let totalScrap = 0;

                        // 1. Calcular Disponibilidad
                        const parosDeMaquina = disponibilidadPorMaquina[maquina] || [];
                        if (parosDeMaquina.length > 0) {
                            parosDeMaquina.forEach(paro => {
                                totalMinutosParo += paro.minutos_perdidos;
                            });
                            const diasConRegistro = new Set(parosDeMaquina.map(p => new Date(p.fecha + 'T12:00:00Z').getUTCDay()));
                            diasConRegistro.forEach(dia => {
                                totalHorasTeoricas += (dia === 5) ? 6.8 : 8.7;
                            });
                        } else {
                            totalHorasTeoricas = (8.7 * 4) + 6.8;
                        }

                        let disponibilidad = 100;
                        if (totalHorasTeoricas > 0) {
                            const horasDisponibles = totalHorasTeoricas - (totalMinutosParo / 60);
                            disponibilidad = (horasDisponibles / totalHorasTeoricas) * 100;
                        }

                        // 2. Calcular Eficiencia y Calidad
                        const produccionDeMaquina = eficienciaPorMaquina[maquina] || [];
                        produccionDeMaquina.forEach(d => {
                            totalPiezasProgramadas += parseFloat(d.piezas_programadas);
                            totalPiezasReales += parseFloat(d.piezas_reales);
                            totalScrap += parseFloat(d.scrap);
                        });

                        const piezasProducidasTotales = totalPiezasReales + totalScrap;
                        
                        const eficiencia = totalPiezasProgramadas > 0 ? (totalPiezasReales / totalPiezasProgramadas) * 100 : 0;
                        const calidad = piezasProducidasTotales > 0 ? (totalPiezasReales / piezasProducidasTotales) * 100 : 0;
                        
                        // 3. Calcular OEE
                        const oee = (disponibilidad / 100) * (eficiencia / 100) * (calidad / 100) * 100;

                        oeePorMaquina[maquina] = {
                            disponibilidad: disponibilidad,
                            eficiencia: eficiencia,
                            calidad: calidad,
                            oee: oee
                        };
                    });

                    return oeePorMaquina;
                } catch (error) {
                    console.error('Error al calcular el OEE:', error);
                    return {};
                }
            }

            async function mostrarResultados() {
                const oeeValores = await obtenerYCalcularOEE();
                const oeeTableBody = document.querySelector('#oeeTable tbody');
                oeeTableBody.innerHTML = '';

                const maquinas = Object.keys(oeeValores);
                
                // Datos para el gráfico
                const labels = [];
                const disponibilidadData = [];
                const rendimientoData = [];
                const calidadData = [];
                
                maquinas.forEach(maquina => {
                    const valores = oeeValores[maquina];
                    
                    // Llenar la tabla
                    const row = oeeTableBody.insertRow();
                    row.insertCell().textContent = maquina;
                    row.insertCell().textContent = `${valores.disponibilidad.toFixed(2)}%`;
                    row.insertCell().textContent = `${valores.eficiencia.toFixed(2)}%`;
                    row.insertCell().textContent = `${valores.calidad.toFixed(2)}%`;
                    row.insertCell().textContent = `${valores.oee.toFixed(2)}%`;
                    
                    // Llenar los arrays para el gráfico
                    labels.push(maquina);
                    disponibilidadData.push(valores.disponibilidad.toFixed(2));
                    rendimientoData.push(valores.eficiencia.toFixed(2));
                    calidadData.push(valores.calidad.toFixed(2));
                });
                
                // Configuración del gráfico
                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Disponibilidad',
                            data: disponibilidadData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Rendimiento',
                            data: rendimientoData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Calidad',
                            data: calidadData,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                };

                const config = {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Porcentaje (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toFixed(2) + '%';
                                        return label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 80,
                                        yMax: 80,
                                        borderColor: 'rgb(255, 99, 132)',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            enabled: true,
                                            content: 'Objetivo (80%)',
                                            position: 'start'
                                        }
                                    }
                                }
                            }
                        }
                    },
                };
                
                new Chart(
                    document.getElementById('oeeChart'),
                    config
                );
            }
            
            mostrarResultados();
        });
    </script>
</body>
</html>