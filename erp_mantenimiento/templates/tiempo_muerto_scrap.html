<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/logo empresa.png" type="image/png">
    <title>Matsa - Indicador de cumplimiento</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
                    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro semitransparente */
        display: flex;
        justify-content: center;
        align-items: center;

        /* Propiedades para la animación */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        /* La clase `show` activará la visibilidad y opacidad */
    }

    .modal.show {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background-color: #fefefe;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        text-align: center;
        max-width: 400px;
        min-width: 300px;
    }

    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
    }

        #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1001;
    }
    
    .toast {
        min-width: 250px;
        max-width: 400px;
        background-color: #333;
        color: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
    }
    
    .toast.show {
        animation: slideIn 0.5s forwards;
    }
    
    .toast.hide {
        animation: fadeOut 0.5s forwards;
    }

    .toast.info {
        background-color: #2196F3; /* Azul */
    }
    
    .toast.success {
        background-color: #4CAF50; /* Verde */
    }
    
    .toast.error {
        background-color: #F44336; /* Rojo */
    }    .legend-container {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 20px;
    font-size: 1.1em;
    }

         @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

    </style>
</head>
<body>
    <div class="profile-menu-container-top-right">
        <div class="profile-toggle">
            <div class="profile-toggle-content">
                
                <svg class="user-svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12ZM12 14C7.02944 14 3 18.0294 3 23H21C21 18.0294 16.9706 14 12 14Z" fill="white"/>
                </svg>
                
                <span id="user-display">{{ session.get('username', 'Invitado') }}</span>
                <span class="arrow-icon">▲</span>
            </div>
        </div>
        <div class="profile-dropdown-menu hidden">
            <p><strong>Usuario:</strong> {{ session.get('username', 'Invitado') }}</p>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Cerrar sesión</a>
        </div>
    </div>
      <nav>
        <header>
            <img src="/static/logo empresa.png" alt="Logo Empresa"/>
        </header>
        <h2>MATSA - Base de datos</h2>
        <ul>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/">Almacen</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/mantenimento">Mantenimiento</a>
                </div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/piezas">Produccion</a>
                </div>
                <div id="piezas-menu" class="dropdown-menu">
                    <a href="/lista_numeros_de_parte_y_piezas_por_barra">Numeros de parte</a>
                    <a href="/eficiencia">Eficiencia</a>
                    <a href="/disponibilidad">Disponibilidad</a>
                    <a href="/oee">OEE</a>
                    <a href="/tiempo_muerto_scrap">Tiempo muerto</a>
                </div>
            </li>
            {% if user_role == 'admin' %}
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/indicadores">Indicadores</a>
                </div>
            </li>
            {% endif %}
        </ul>
    </nav>

  <main>
        
                    <h2>Tiempo muerto - Produccion</h2>
            <section class="form-section">            

            <div class="chart-container">
                <canvas id="indicadoresChart"></canvas>
            </div>
                    </section>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Máquina</th>
                            <th>Objetivo de T. Muerto (%)</th>
                            <th>T. Muerto Actual (%)</th>
                            <th>Objetivo de Scrap (%)</th>
                            <th>Scrap Actual (%)</th>
                        </tr>
                    </thead>
                    <tbody id="indicadoresTableBody">
                    </tbody>
                </table>
            </div>
  </main>
  <script>
    // Variable para almacenar la instancia del gráfico
    let indicadoresChartInstance = null;

    // Función para obtener los datos y generar el reporte
    async function fetchIndicadoresData() {
        try {
            // Asumiendo un nuevo endpoint en tu backend que devuelve los datos por máquina
            const response = await fetch('/obtener_indicadores_maquinas');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            // Calcular y renderizar los datos
            renderIndicadores(data);
            renderChart(data);
            
        } catch (error) {
            console.error('Error al obtener los indicadores de las máquinas:', error);
            // La función showMessage no está definida en este archivo, puedes usar showToast o definir showMessage
            // showToast('Error al cargar los indicadores. Asegúrate de que el endpoint está configurado.', 'error');
        }
    }

    // Función para renderizar la tabla
    function renderIndicadores(data) {
    const tbody = document.getElementById('indicadoresTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    data.forEach(maquina => {

                console.log("--- DEBUG MAQUINA:", maquina.nombre, "---");
        console.log("Minutos Paro (numerador):", maquina.minutos_paro);
        console.log("Minutos Programados (denominador):", maquina.minutos_programados);
        console.log("Objetivo T. Muerto:", maquina.objetivo_tiempo_muerto);

        const tiempoMuertoPorcentaje = ((maquina.minutos_paro / maquina.minutos_programados) * 100).toFixed(2);
        const scrapPorcentaje = ((maquina.piezas_scrap / maquina.piezas_producidas) * 100).toFixed(2);
        
        // Determinar el color del tiempo muerto
        const tiempoMuertoColor = tiempoMuertoPorcentaje <= maquina.objetivo_tiempo_muerto ? 'green' : 'red';
        
        // Determinar el color del scrap
        const scrapColor = scrapPorcentaje <= maquina.objetivo_scrap ? 'green' : 'red';

        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${maquina.nombre}</td>
            <td>${maquina.objetivo_tiempo_muerto}%</td>
            <td style="color: ${tiempoMuertoColor};"><b>${tiempoMuertoPorcentaje}%</b></td>
            <td>${maquina.objetivo_scrap}%</td>
            <td style="color: ${scrapColor};"><b>${scrapPorcentaje}%</b></td>
        `;
    });
}

// Función para renderizar el gráfico de barras
function renderChart(data) {
    const ctx = document.getElementById('indicadoresChart').getContext('2d');
    
    // Si ya existe un gráfico, destrúyelo para evitar superposiciones
    if (indicadoresChartInstance) {
        indicadoresChartInstance.destroy();
    }

    // Define los objetivos con valores por defecto
    const objetivoTiempoMuerto = data.length > 0 ? data[0].objetivo_tiempo_muerto : 20;
    const objetivoScrap = data.length > 0 ? data[0].objetivo_scrap : 2.50;

    // Si no hay datos, no dibujes nada
    if (!data || data.length === 0) {
        console.warn("No se encontraron datos de máquinas para generar el reporte.");
        return;
    }
    
    // Prepara los datos para el gráfico
    const maquinasNombres = data.map(m => m.nombre);
    const tiempoMuertoDatos = data.map(m => ((m.minutos_paro / m.minutos_programados) * 100).toFixed(2));
    const scrapDatos = data.map(m => ((m.piezas_scrap / m.piezas_producidas) * 100).toFixed(2));

    const tiempoMuertoColors = data.map(m => 
        ((m.minutos_paro / m.minutos_programados) * 100) <= m.objetivo_tiempo_muerto ? 'rgba(54, 162, 235, 0.5)' : 'rgba(255, 99, 132, 0.5)'
    );

    const scrapColors = data.map(m => 
        ((m.piezas_scrap / m.piezas_producidas) * 100) <= m.objetivo_scrap ? 'rgba(54, 162, 235, 0.5)' : 'rgba(255, 99, 132, 0.5)'
    );
    

    indicadoresChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: maquinasNombres,
            datasets: [
                {
                    label: 'Tiempo Muerto (%)',
                    data: tiempoMuertoDatos,
                    backgroundColor: tiempoMuertoColors,
                    borderColor: tiempoMuertoColors.map(c => c.replace('0.5', '1')),
                    borderWidth: 1,
                },
                {
                    label: 'Scrap (%)',
                    data: scrapDatos,
                    backgroundColor: scrapColors,
                    borderColor: scrapColors.map(c => c.replace('0.5', '1')),
                    borderWidth: 1,
                },
                {
                    label: 'Objetivo T. Muerto',
                    data: maquinasNombres.map(() => objetivoTiempoMuerto),
                    type: 'line',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    datalabels: {
                        display: false 
                    }
                },
                {
                    label: 'Objetivo Scrap',
                    data: maquinasNombres.map(() => objetivoScrap),
                    type: 'line',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    datalabels: {
                        display: false
                    }
                }
            ]
        },
        options: {
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}%`;
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    formatter: (value, context) => {
                        if (context.dataset.type === 'bar') {
                            return value + '%';
                        }
                        return null;
                    },
                    color: 'black',
                    font: {
                        weight: 'bold'
                    }
                }
            },
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Porcentaje (%)'
                    }
                }
            }
        }
    });
}
    // Asegúrate de llamar a la función para cargar los datos al inicio
    document.addEventListener('DOMContentLoaded', () => {
        const profileToggle = document.querySelector('.profile-toggle');
        const profileContainer = document.querySelector('.profile-menu-container-top-right');
        const profileMenu = document.querySelector('.profile-dropdown-menu');

        if (profileToggle && profileMenu && profileContainer) {
            profileToggle.addEventListener('click', () => {
                // Oculta/Muestra el menú usando la clase 'hidden'
                profileMenu.classList.toggle('hidden'); 
                // Añade/Remueve la clase 'active' para girar el icono de la flecha
                profileContainer.classList.toggle('active');
            });
        }
        document.addEventListener('click', (event) => {
                const profileContainer = document.querySelector('.profile-menu-container-top-right');
                const isClickInsideContainer = event.target.closest('.profile-menu-container-top-right');
                
                if (!profileMenu.classList.contains('hidden') && !isClickInsideContainer) {
                    profileMenu.classList.add('hidden');
                    if (profileContainer) {
                        profileContainer.classList.remove('active'); // Asegura que la flecha vuelva a subir
                    }
                }
            });
        fetchIndicadoresData();
    });

  </script>

</body>
</html>