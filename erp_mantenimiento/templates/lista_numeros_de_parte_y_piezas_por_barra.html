<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Matsa - Registro de Partes y Piezas</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="/static/logo empresa.png" type="image/png">
    <style>
        /* Estilos base del modal de almacenamiento.html */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-20px); /* Comienza un poco más arriba */
            transition: transform 0.3s ease;
            text-align: center;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #555;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-danger {
            background-color: rgb(234, 0, 0);
            color: white;
        }

        .btn-danger:hover {
            background-color: rgb(181, 2, 2);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        /* Estilos para los mensajes "toast" de almacenamiento.html */
        
        
        /* Estilos adicionales si son necesarios para ocultar/mostrar */
        .hidden {
            display: none;
        }

        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }
        
        .toast {
            min-width: 250px;
            max-width: 400px;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .toast.show {
            animation: slideIn 0.5s forwards;
        }
        
        .toast.hide {
            animation: fadeOut 0.5s forwards;
        }

        .toast.info {
            background-color: #2196F3; /* Azul */
        }
        
        .toast.success {
            background-color: #4CAF50; /* Verde */
        }
        
        .toast.error {
            background-color: #F44336; /* Rojo */
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
    </style>
</head>
<body>
    <div class="profile-menu-container-top-right">
        <div class="profile-toggle">
            <div class="profile-toggle-content">
                
                <svg class="user-svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12ZM12 14C7.02944 14 3 18.0294 3 23H21C21 18.0294 16.9706 14 12 14Z" fill="white"/>
                </svg>
                
                <span id="user-display">{{ session.get('username', 'Invitado') }}</span>
                <span class="arrow-icon">▲</span>
            </div>
        </div>
        <div class="profile-dropdown-menu hidden">
            <p><strong>Usuario:</strong> {{ session.get('username', 'Invitado') }}</p>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Cerrar sesión</a>
        </div>
    </div>
    <nav>
        <header>
            <img src="/static/logo empresa.png" alt="Logo Empresa"/>
        </header>
        <h2>MATSA - Base de datos</h2>
        <ul>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/">Almacen</a>
                </div>
                <div ></div>
                </div>
            </li>
            
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/mantenimento">Mantenimiento</a>
                </div>
                <div></div>
            </li>
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/piezas">Produccion</a>
                </div>
                <div id="piezas-menu" class="dropdown-menu">
                    <a href="/lista_numeros_de_parte_y_piezas_por_barra">Numeros de parte</a>
                    <a href="/eficiencia">Eficiencia</a>
                    <a href="/disponibilidad">Disponibilidad</a>
                    <a href="/oee">OEE</a>
                    <a href="/tiempo_muerto_scrap">Tiempo muerto</a>
                </div>
            </li>
            {% if user_role == 'admin' %}
            <li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/indicadores">Indicadores</a>
                </div>
            </li>
            {% endif %}
            <!--<li class="dropdown">
                <div class="dropdown-toggle">
                    <a href="/ventas">Ventas</a>
                </div>
                <div></div>
            </li>-->
        </ul>
    </nav>
    <main>
        <h2>Registro de números de parte y piezas por barra</h2>

        <section class="form-section">
            <div>
            <label for="noParteInterno">No. de parte interno (3-4 dígitos):</label>
            <input type="text" id="noParteInterno" maxlength="4" pattern="[0-9]{3,4}" title="Debe ser 3 o 4 dígitos numéricos" required>
            </div>

            <div>
            <label for="noParteCliente">No. de parte del cliente:</label>
            <input type="text" id="noParteCliente" required>
            </div>

            <div>
            <label for="descripcion">Descripción:</label>
            <input type="text" id="descripcion" required>
            </div>

            <div>
            <label for="cliente">Cliente:</label>
            <input type="text" id="cliente" required>
            </div>

            <div>
            <label for="materiaPrima">Materia prima:</label>
            <input type="text" id="materiaPrima" required>
            </div>

            <div> {# Contenedor para el nuevo campo de Medida en Pulgadas #}
                <label for="medidaPulgadasInput">Medida en milimetros:</label>
                <input type="number" id="medidaPulgadasInput" step="0.001" oninput="convertPulgadasToMM()">
            </div>
            
            {# Este input estará oculto en el formulario, pero su valor se calculará y guardará #}
            <input type="hidden" id="medidaMilimetrosInput">

            <div> {# NUEVO CAMPO: Longitud Medida #}
                <label for="longitudMedidaInput">Longitud en pulgadas:</label>
                <input type="number" id="longitudMedidaInput" min="0" step="0.01">
            </div>

            <div> {# Nuevo campo: Pieza x hora #}
                <label for="piezaXHoraInput">Pieza x hora:</label>
                <input type="number" id="piezaXHoraInput" min="0" step="1"> {# Añadido step="1" #}
            </div>

            <div> {# Nuevo campo: Pieza x turno L A J #}
                <label for="piezaXTurnoLAJInput">Pieza x turno L A J:</label>
                <input type="number" id="piezaXTurnoLAJInput" min="0">
            </div>

            <div>
            <label for="piezasPorBarra">Piezas/barra (opcional):</label>
            <input type="number" id="piezasPorBarra" min="0">
            </div>
        </section>
        <div class="form-buttons">
                <button onclick="guardarPartePieza()">Guardar Parte/Pieza</button>
                <button onclick="limpiarFormulario()">Limpiar Formulario</button>
            </div>
        <section class="form-section">
        <h3>Buscar por No. de Parte Interno</h3>
        <div class="search-section">
            <input type="text" id="busquedaInterna" oninput="buscarPartePiezaInterno()" placeholder="Buscar por No. de Parte Interno">
        </div>
        </section>
        <h3>Listado de Partes y Piezas</h3>
        <table id="tablaPartesPiezas">
            <thead>
                <tr>
                    
                    <th>No. Parte Interno</th>
                    <th>No. Parte Cliente</th>
                    <th>Descripción</th>
                    <th>Cliente</th>
                    <th>Materia Prima</th>
                    <th>Medida en Milímetros</th> 
                    <th>Longitud Medida</th>
                    <th>Pieza x hora</th> 
                    <th>Pieza x Turno L A J</th> 
                    <th>Piezas/Barra</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="cuerpoTablaPartesPiezas">
            </tbody>
        </table>

    </main>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDeleteModalBtn">&times;</span>
            <h2>Confirmar Eliminación</h2>
            <p id="deleteConfirmationMessage">¿Estás seguro de que quieres eliminar este número de parte?</p>
            <div class="button-group">
                <button id="confirmDeleteBtn" class="btn btn-danger">Sí, Eliminar</button>
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const USER_ROLE = "{{ user_role }}"; 

        let partePiezaToDelete = null;
        let partePiezaAEditarId = null; // Variable para almacenar el ID del elemento a editar

        const deleteConfirmModal = document.getElementById("deleteConfirmModal");
        const deleteConfirmationMessage = document.getElementById("deleteConfirmationMessage");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const closeDeleteModalBtn = document.getElementById("closeDeleteModalBtn");
        const toastContainer = document.getElementById("toastContainer");

        // Función para convertir pulgadas a milímetros
        function convertPulgadasToMM() {
            const pulgadas = parseFloat(document.getElementById('medidaPulgadasInput').value);
            if (isNaN(pulgadas) && document.getElementById('medidaPulgadasInput').value !== '') {
                // Podrías mostrar una alerta o un mensaje de error al usuario
                alert("Por favor, ingresa un valor numérico para la medida en pulgadas.");
                document.getElementById('medidaMilimetrosInput').value = ''; // Limpiar el campo
            } else if (!isNaN(pulgadas)) {
                const mm = (pulgadas * 25.4).toFixed(3); // Convertir y redondear a 3 decimales
                document.getElementById('medidaMilimetrosInput').value = mm;
            } else {
                document.getElementById('medidaMilimetrosInput').value = '';
            }
        }

        function guardarPartePieza() {
            const noParteInterno = document.getElementById("noParteInterno").value;
            const noParteCliente = document.getElementById("noParteCliente").value;
            const descripcion = document.getElementById("descripcion").value;
            const cliente = document.getElementById("cliente").value;
            const materiaPrima = document.getElementById("materiaPrima").value;
            const piezasPorBarra = document.getElementById("piezasPorBarra").value;
            
            // Obtener y convertir la medida en pulgadas a milímetros
            const medidaPulgadas = document.getElementById('medidaPulgadasInput').value;
            convertPulgadasToMM(); // Asegura que medidaMilimetrosInput.value esté actualizado
            const medidaMilimetros = document.getElementById('medidaMilimetrosInput').value;

            const longitudMedida = document.getElementById('longitudMedidaInput').value;

            // Nuevos campos
            const piezaXHora = document.getElementById('piezaXHoraInput').value;
            const piezaXTurnoLAJ = document.getElementById('piezaXTurnoLAJInput').value;


            // Validación básica de campos requeridos
            if (!noParteInterno || !noParteCliente || !descripcion || !cliente || !materiaPrima) {
                showMessage("Por favor, completa todos los campos obligatorios.");
                return;
            }

            // Validación de formato para No. de parte interno
            const internalPartRegex = /^[0-9]{3,4}$/;
            if (!internalPartRegex.test(noParteInterno)) {
                showMessage("El 'No. de parte interno' debe ser de 3 o 4 dígitos numéricos.");
                return;
            }

            const data = {
                no_parte_interno: noParteInterno,
                no_parte_cliente: noParteCliente,
                descripcion: descripcion,
                cliente: cliente,
                materia_prima: materiaPrima,
                medida_pulgadas: medidaPulgadas,        // Guardar pulgadas
                medida_milimetros: medidaMilimetros,     // Guardar milímetros
                longitud_medida: longitudMedida ? parseFloat(longitudMedida) : null, // NUEVO: Guardar longitud_medida como número o null
                pieza_x_hora: piezaXHora ? parseInt(piezaXHora) : null, // Asegura que se guarde como entero
                pieza_x_turno_laj: piezaXTurnoLAJ ? parseInt(piezaXTurnoLAJ) : null, // Asegura que se guarde como entero
                piezas_por_barra: piezasPorBarra ? parseInt(piezasPorBarra) : null // Convertir a número o null
            };

            const url = partePiezaAEditarId ? `/actualizar_parte_pieza/${partePiezaAEditarId}` : '/guardar_parte_pieza';
            const method = partePiezaAEditarId ? 'POST' : 'POST'; // Ambos son POST

            fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(responseData => {
                showMessage(responseData.status === "guardado" ? "Parte/Pieza guardada correctamente" : "Parte/Pieza actualizada correctamente");
                cargarPartesPiezasTabla(); // Recargar la tabla
                limpiarFormulario(); // Limpiar el formulario
            })
            .catch(error => {
            console.error('Error al cargar partes y piezas:', error);
            showMessage("Error al cargar partes y piezas: " + error.message);
        });

        }

        function limpiarFormulario() {
            document.getElementById("noParteInterno").value = "";
            document.getElementById("noParteCliente").value = "";
            document.getElementById("descripcion").value = "";
            document.getElementById("cliente").value = "";
            document.getElementById("materiaPrima").value = "";
            document.getElementById("medidaPulgadasInput").value = ""; // Limpiar campo de pulgadas
            document.getElementById("medidaMilimetrosInput").value = ""; // Limpiar campo oculto de milímetros
            document.getElementById("longitudMedidaInput").value = ""; // NUEVO: Limpiar longitud medida
            document.getElementById("piezaXHoraInput").value = ""; // Limpiar nuevo campo
            document.getElementById("piezaXTurnoLAJInput").value = ""; // Limpiar nuevo campo
            document.getElementById("piezasPorBarra").value = "";

            const guardarBtn = document.querySelector('button[onclick="guardarPartePieza()"]');
            guardarBtn.textContent = "Guardar Parte/Pieza";
            partePiezaAEditarId = null; // Resetear el ID de edición
        }

        function cargarPartesPiezasTabla() {
            fetch('/obtener_partes_piezas')
                .then(response => response.json())
                .then(data => {
                    const cuerpoTabla = document.getElementById("cuerpoTablaPartesPiezas");
                    cuerpoTabla.innerHTML = ""; // Limpiar tabla antes de cargar
                    data.forEach(item => {
                        const fila = cuerpoTabla.insertRow();
                        fila.dataset.id = item[0]; // Guardar el ID en el dataset de la fila

                        //fila.insertCell().textContent = item[0]; // ID
                        fila.insertCell().textContent = item[1]; // No. Parte Interno
                        fila.insertCell().textContent = item[2]; // No. Parte Cliente
                        fila.insertCell().textContent = item[3]; // Descripción
                        fila.insertCell().textContent = item[4]; // Cliente
                        fila.insertCell().textContent = item[5]; // Materia Prima
                        fila.insertCell().textContent = item[7] !== null ? parseFloat(item[7]).toFixed(3) : ''; // Medida en Milímetros (item[7])
                        fila.insertCell().textContent = item[11] !== null ? parseFloat(item[11]).toFixed(3) : '';//Longitud medida (item[11])
                        fila.insertCell().textContent = item[8] !== null ? parseInt(item[8]) : ''; // Pieza x hora (item[8]) - AHORA COMO ENTERO
                        fila.insertCell().textContent = item[9] !== null ? item[9] : ''; // Pieza x Turno L A J (item[9])
                        fila.insertCell().textContent = item[10] !== null ? item[10] : ''; // Piezas/Barra (item[10])
                        // NO se muestra item[6] (medida_pulgadas) en la tabla

                        const accionesCell = fila.insertCell();
                        if (USER_ROLE !== 'employee') { 

                        const botonEditar = document.createElement("button");
                        botonEditar.textContent = "Editar";
                        botonEditar.classList.add("accion-btn", "edit");
                        botonEditar.onclick = () => editarPartePieza(item[0]);
                        accionesCell.appendChild(botonEditar);

                        const botonBorrar = document.createElement("button");
                        botonBorrar.textContent = "Borrar";
                        botonBorrar.classList.add("accion-btn", "delete");
                        botonBorrar.onclick = () => openDeleteConfirmModal(item[0]);
                        accionesCell.appendChild(botonBorrar);
                        }
                    });
                })
                
                .catch(error => {
            console.error('Error al cargar partes y piezas:', error);
            showMessage("Error al cargar partes y piezas: " + error.message);
        });

        }

        function editarPartePieza(id) {
            partePiezaAEditarId = id; // Establecer el ID para editar
            fetch(`/obtener_parte_pieza/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        document.getElementById("noParteInterno").value = data[1];
                        document.getElementById("noParteCliente").value = data[2];
                        document.getElementById("descripcion").value = data[3];
                        document.getElementById("cliente").value = data[4];
                        document.getElementById("materiaPrima").value = data[5];
                        document.getElementById("medidaPulgadasInput").value = data[6] || ''; // Cargar pulgadas
                        document.getElementById("medidaMilimetrosInput").value = data[7] || ''; // Cargar milímetros (oculto)
                        document.getElementById("longitudMedidaInput").value = data[11] || ''; // NUEVO: Cargar longitud medida (item[11])
                        document.getElementById("piezaXHoraInput").value = data[8] !== null ? parseInt(data[8]) : ''; // Cargar nuevo campo - AHORA COMO ENTERO
                        document.getElementById("piezaXTurnoLAJInput").value = data[9] || ''; // Cargar nuevo campo
                        document.getElementById("piezasPorBarra").value = data[10] !== null ? data[10] : ''; // Cargar piezas/barra

                        // Cambiar texto del botón para indicar "Actualizar"
                        const guardarBtn = document.querySelector('button[onclick="guardarPartePieza()"]');
                        guardarBtn.textContent = "Actualizar Parte/Pieza";
                    }
                })
                .catch(error => console.error('Error al obtener parte/pieza para editar:', error));
                showMessage("Error al obtener parte/pieza para editar: " + error.message);
        }

        async function borrarPartePieza(id) {
            try{
                const response = await fetch(`eliminar_parte_pieza/${id}`, {
                    method: 'POST'
                });
                if(response.ok){
                    const data = await response.json();
                    showMessage(data.message, 'succes');
                    cargarPartesPiezasTabla();
                }else{
                    const errorData = await response.json();
                    showMessage(errorData.message, 'error');
                }
            } catch(error){
                console.error('Error al eliminar:', error);
                showMessage("Ocurrio un error al eliminar el registro.", 'error');
            }
            
        }

        function buscarPartePiezaInterno() {
            const termino = document.getElementById("busquedaInterna").value;
            fetch(`/buscar_parte_pieza_interno?q=${termino}`)
                .then(response => response.json())
                .then(data => {
                    const cuerpoTabla = document.getElementById("cuerpoTablaPartesPiezas");
                    cuerpoTabla.innerHTML = ""; // Limpiar tabla
                    data.forEach(item => {
                        const fila = cuerpoTabla.insertRow();
                        fila.dataset.id = item[0];

                        fila.insertCell().textContent = item[1]; // No. Parte Interno
                        fila.insertCell().textContent = item[2]; // No. Parte Cliente
                        fila.insertCell().textContent = item[3]; // Descripción
                        fila.insertCell().textContent = item[4]; // Cliente
                        fila.insertCell().textContent = item[5]; // Materia Prima
                        fila.insertCell().textContent = item[7] !== null ? parseFloat(item[7]).toFixed(3) : ''; // Medida en Milímetros (item[7])
                        fila.insertCell().textContent = item[11] !== null ? parseFloat(item[11]).toFixed(2) : ''; // NUEVO: Longitud Medida (item[11])
                        fila.insertCell().textContent = item[8] !== null ? parseInt(item[8]) : ''; // Pieza x hora (item[8]) - AHORA COMO ENTERO
                        fila.insertCell().textContent = item[9] !== null ? item[9] : ''; // Pieza x Turno L A J (item[9])
                        fila.insertCell().textContent = item[10] !== null ? item[10] : ''; // Piezas/Barra (item[10])


                        const accionesCell = fila.insertCell();
                        if (USER_ROLE !== 'employee') { 

                        const botonEditar = document.createElement("button");
                        botonEditar.textContent = "Editar";
                        botonEditar.classList.add("accion-btn", "edit");
                        botonEditar.onclick = () => editarPartePieza(item[0]);
                        accionesCell.appendChild(botonEditar);

                        const botonBorrar = document.createElement("button");
                        botonBorrar.textContent = "Borrar";
                        botonBorrar.classList.add("accion-btn", "delete");
                        botonBorrar.onclick = () => openDeleteConfirmModal(item[0]);
                        accionesCell.appendChild(botonBorrar);
                        }
                    });
                })
                .catch(error => {
                console.error('Error al cargar partes y piezas:', error);
                showMessage("Error al cargar partes y piezas: " + error.message);
            });

        }

        // Función para mostrar mensajes "toast"
        function showMessage(message, type = 'info') {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Usa setTimeout para dar tiempo al navegador para aplicar los estilos antes de la animación
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Eliminar el toast después de 5 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                
                // Espera a que la animación de salida termine para eliminar el elemento del DOM
                toast.addEventListener('animationend', () => {
                    toast.remove();
                }, { once: true });
            }, 5000);
        }

        function openModal(modalElement) {
            if (modalElement) {
                modalElement.style.display = 'flex';
                void modalElement.offsetWidth;
                modalElement.classList.add('show');
            }
        }

        function closeModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('show');
                setTimeout(() => {
                    modalElement.style.display = 'none';
                }, 300);
            }
        }

        // Función para abrir el modal de confirmación de eliminación
        function openDeleteConfirmModal(id) {
            partePiezaIdToDelete = id;
            if (deleteConfirmationMessage) {
                deleteConfirmationMessage.textContent = `¿Estás seguro de que quieres eliminar el número de parte con ID ${id}?`;
            }
            openModal(deleteConfirmModal);
        }

        // Función para cerrar el modal de confirmación de eliminación
        function closeDeleteConfirmModal() {
            partePiezaIdToDelete = null;
            closeModal(deleteConfirmModal);
        }

        // Toggle para el menú desplegable (si tienes uno en tu nav)
        document.addEventListener('DOMContentLoaded', () => {
            const profileToggle = document.querySelector('.profile-toggle');
            const profileContainer = document.querySelector('.profile-menu-container-top-right');
            const profileMenu = document.querySelector('.profile-dropdown-menu');

            if (profileToggle && profileMenu && profileContainer) {
                profileToggle.addEventListener('click', () => {
                    // Oculta/Muestra el menú usando la clase 'hidden'
                    profileMenu.classList.toggle('hidden'); 
                    // Añade/Remueve la clase 'active' para girar el icono de la flecha
                    profileContainer.classList.toggle('active');
                });
            }
            document.addEventListener('click', (event) => {
                const profileContainer = document.querySelector('.profile-menu-container-top-right');
                const isClickInsideContainer = event.target.closest('.profile-menu-container-top-right');
                
                if (!profileMenu.classList.contains('hidden') && !isClickInsideContainer) {
                    profileMenu.classList.add('hidden');
                    if (profileContainer) {
                        profileContainer.classList.remove('active'); // Asegura que la flecha vuelva a subir
                    }
                }
            });
            cargarPartesPiezasTabla();

            confirmDeleteBtn.addEventListener('click', () => {
                if (partePiezaIdToDelete) {
                    borrarPartePieza(partePiezaIdToDelete);
                    closeDeleteConfirmModal();
                }
            });

            cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
            closeDeleteModalBtn.addEventListener('click', closeDeleteConfirmModal);

            const dropdownToggle = document.querySelector('.dropdown-toggle');
            if (dropdownToggle) {
                dropdownToggle.addEventListener('click', function() {
                    const dropdownMenu = this.nextElementSibling;
                    if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
                    }
                });
            }
        });
    </script>
</body>
</html>
